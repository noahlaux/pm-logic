<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="logic-behavior.html">

<script>
    var behavior = {

        properties: {
            isInViewport: String,

            element: {
                computed: 'getElement(when)'
            },

            viewport: {
                computed: 'getViewport(isInViewport)'
            },

            currentScroll: {
                type: Number,
                value: 0
            },

            isReady: {
                type: Boolean,
                value: false
            }
        },

        observers: [
            'validate("isInViewport", element, viewport, currentScroll)',
            'setupListeners(viewport, isReady)'
        ],

        created: function () {
            this.registerValidator('isInViewport', this.isElementInViewport.bind(this));
        },

        attached: function () {
            this.async(function () {
                this.set('isReady', true);
                window.requestAnimationFrame(function () {
                    this.validate('isInViewport', this.element, this.viewport);
                }.bind(this));
            }, 10);
        },

        setupListeners: function (viewport) {
            this.scrollListener = viewport.addEventListener('scroll', function (event) {
                window.requestAnimationFrame(function () {
                    this.currentScroll = event.target.scrollTop;
                }.bind(this));
            }.bind(this));

            this.resizeListener = window.addEventListener('resize', function (event) {
                window.requestAnimationFrame(function () {
                    this.validate('isInViewport', this.element, this.viewport);
                }.bind(this));
            }.bind(this));
        },

        isElementInViewport: function (element, viewport) {

            function check () {
                var rect     = element.getBoundingClientRect();
                var vWidth   = window.innerWidth;
                var vHeight  = window.innerHeight;
                var efp      = function (x, y) {
                    viewport
                    return document.elementFromPoint(x, y);
                };

                // Return false if it's not in the viewport
                if (rect.right < 0 || rect.bottom < 0
                        || rect.left > vWidth || rect.top + 50 > vHeight) {
                    return false;
                }

                return true;
                // Return true if any of its four corners are visible
                // return (
                //     element.contains(efp(rect.left,  rect.top)) ||
                //     element.contains(efp(rect.right, rect.top)) ||
                //     element.contains(efp(rect.right, rect.bottom)) ||
                //     element.contains(efp(rect.left,  rect.bottom))
                // );
            }

            return check();
        },

        getElement: function (selector) {
            return this.dataHost.$$(selector);
        },

        getViewport: function (selector) {
            return typeof selector === 'object' ? selector : this.getElement(selector);
        },

        detached: function () {
            if (this.viewport) {
                this.viewport.removeEventListener('scroll', this.scrollListener);
                this.viewport.removeEventListener('resize', this.resizeListener);
            }
        }
    };

    ElementBehavior = [LogicBehavior, behavior];
</script>
